import com.gargoylesoftware.htmlunit.ElementNotFoundException;
import org.openqa.selenium.By;
import org.openqa.selenium.JavascriptExecutor;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;


import java.io.File;
import java.io.FileWriter;
import java.net.MalformedURLException;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Set;

/**
 * Created by saimachavarapu on 2/4/14.
 */
public class SubscriptionGenerator {
    //load the properties from the file
    HashMap<String,String> configMap;
    WebDriver driver;
    FormElements myFormElement;
    WebDriverWait webDriverWait;
    int iteration=1;
    SubscriptionGenerator(){
        //read the properties file and initialize necessary things
        //initialize the webdriver
        try {
            configMap = PropertiesLoader.load(new File("src/main/resources/SiteDetails.properties"));
            driver = DriverProvider.getDriver();
            webDriverWait=new WebDriverWait(driver, 6000);
        } catch (Exception e) {
            e.printStackTrace();
        }

    }
    public static void main(String args[]) throws MalformedURLException {

        SubscriptionGenerator generator = new SubscriptionGenerator();
        for(int i=1;i<15;i++){
            try{
                generator.iteration=i;
                generator.dreamSparkSignUp();
                generator.verifyAcademicStatus();
                //save login details and pluralsight key
                generator.saveUserDetailsAndKey();
                generator.logoutUser();
            }catch (Exception e){
                e.printStackTrace();
            }
        }
    }

    public void dreamSparkSignUp(){
        //navigate to the signup Page
        driver.get(configMap.get("signUpPageURL"));
        FormElements form = new FormGenerator().getForm();
        this.myFormElement=form;
        //fill the form
        //just wait 5 seconds before filling the form to avoid risk of spam detection
        try{
            Thread.sleep(5000);
        }catch (InterruptedException e){e.printStackTrace();}
        driver.findElement(By.xpath(configMap.get("firstNameXpath"))).clear();
        driver.findElement(By.xpath(configMap.get("firstNameXpath"))).sendKeys(form.getFirstName());

        driver.findElement(By.xpath(configMap.get("lastNameXpath"))).clear();
        driver.findElement(By.xpath(configMap.get("lastNameXpath"))).sendKeys(form.getLastName());

        driver.findElement(By.xpath(configMap.get("monthButtonXpath"))).click();
        webDriverWait.until(ExpectedConditions.visibilityOfElementLocated(By.xpath(configMap.get("monthSelectXpath"))));
        driver.findElement(By.xpath(configMap.get("monthSelectXpath"))).click();

        driver.findElement(By.xpath(configMap.get("yearButtonXpath"))).click();
        webDriverWait.until(ExpectedConditions.visibilityOfElementLocated(By.xpath(configMap.get("yearSelectXpath"))));
        driver.findElement(By.xpath(configMap.get("yearSelectXpath"))).click();
        try{
            Thread.sleep(2000);
        }catch (InterruptedException e){e.printStackTrace();}

        //get the script to be executed on click of day
        String scriptText = driver.findElement(By.xpath(configMap.get("dayXpath"))).getAttribute("href");
        //use javascript to select day
        ((JavascriptExecutor) driver).executeScript(scriptText.substring(11,scriptText.length()));
        //wait till the day is selected
        webDriverWait.until(ExpectedConditions.visibilityOfElementLocated(By.xpath(configMap.get("selectedDayStyleXpath"))));
        driver.findElement(By.xpath(configMap.get("emailXpath"))).clear();
        driver.findElement(By.xpath(configMap.get("emailXpath"))).sendKeys(form.getEmail());

        driver.findElement(By.xpath(configMap.get("confirmEmailXpath"))).clear();
        driver.findElement(By.xpath(configMap.get("confirmEmailXpath"))).sendKeys(form.getEmail());

        driver.findElement(By.xpath(configMap.get("languageButtonXpath"))).click();
        driver.findElement(By.xpath(configMap.get("languageSelectXpath"))).click();

        driver.findElement(By.xpath(configMap.get("countryButtonXpath"))).click();
        driver.findElement(By.xpath(configMap.get("countrySelectXpath"))).click();

        driver.findElement(By.xpath(configMap.get("passwordXpath"))).clear();
        driver.findElement(By.xpath(configMap.get("passwordXpath"))).sendKeys(form.getPassword());

        driver.findElement(By.xpath(configMap.get("confirmPasswordXpath"))).clear();
        driver.findElement(By.xpath(configMap.get("confirmPasswordXpath"))).sendKeys(form.getPassword());

        driver.findElement(By.xpath(configMap.get("continueVerifyXpath"))).click();
    }

    public void verifyAcademicStatus(){
        webDriverWait.until(ExpectedConditions.visibilityOfElementLocated(By.xpath(configMap.get("verifySchoolXpath"))));
        driver.findElement(By.xpath(configMap.get("verifySchoolXpath"))).click();
        //wait till the input field for school text is loaded
        webDriverWait.until(ExpectedConditions.visibilityOfElementLocated(By.xpath(configMap.get("schoolTextXpath"))));
        driver.findElement(By.xpath(configMap.get("schoolTextXpath"))).clear();
        driver.findElement(By.xpath(configMap.get("schoolTextXpath"))).sendKeys(configMap.get("schoolName"));
        //wait till the school select suggestion comes up
        webDriverWait.until(ExpectedConditions.visibilityOfElementLocated(By.xpath(configMap.get("schoolSelectXpath"))));
        driver.findElement(By.xpath(configMap.get("schoolSelectXpath"))).click();
        driver.findElement(By.xpath(configMap.get("schoolContinueXpath"))).click();
        //wait for 5 second for the popup
        try{
            Thread.sleep(5000);

        }catch (InterruptedException e){e.printStackTrace();}
        //switching to the popup window and filling in the details in college page
        String parentWindowHandler = driver.getWindowHandle(); // Store your parent window
        String subWindowHandler = null;
        Set<String> handles = driver.getWindowHandles(); // get all window handles
        Iterator<String> iterator = handles.iterator();
        while (iterator.hasNext()){
            subWindowHandler = iterator.next();
        }
        //only if authentication needed do this.
        //if cookie stored , no popup then just proceed further
        if(subWindowHandler!=null && !subWindowHandler.equals("")&&this.iteration==1){
            driver.switchTo().window(subWindowHandler); // switch to popup window
            /** perform operations on popup**/
            //Authenticate from college id
            verifyCollegeLoginDetails();
            driver.switchTo().window(parentWindowHandler);  // switch back to parent window
        }
        webDriverWait.until(ExpectedConditions.titleIs("Microsoft DreamSpark - Congratulation"));
        try{
            Thread.sleep(5000);
        }catch (InterruptedException e){e.printStackTrace();}
    }
    public void verifyCollegeLoginDetails(){
        webDriverWait.until(ExpectedConditions.visibilityOfElementLocated(By.xpath(configMap.get("collegeUserNameXpath"))));
        driver.findElement(By.xpath(configMap.get("collegeUserNameXpath"))).clear();
        driver.findElement(By.xpath(configMap.get("collegeUserNameXpath"))).sendKeys(configMap.get("collegeUserName"));

        driver.findElement(By.xpath(configMap.get("collegePasswordXpath"))).clear();
        driver.findElement(By.xpath(configMap.get("collegePasswordXpath"))).sendKeys(configMap.get("collegePassword"));

        driver.findElement(By.xpath(configMap.get("collegeLoginButtonXpath"))).click();

    }
    public void saveUserDetailsAndKey() {
        //navigate to the pluralsight key url
        driver.get(configMap.get("pluralSightKeyPageUrl"));
        //wait till the pluralsight key button is loaded
        webDriverWait.until(ExpectedConditions.visibilityOfElementLocated(By.xpath(configMap.get("pluralSightKeyButtonXpath"))));
        //click on get key
        driver.findElement(By.xpath(configMap.get("pluralSightKeyButtonXpath"))).click();
        //wait till the key is generated
        webDriverWait.until(ExpectedConditions.visibilityOfElementLocated(By.xpath(configMap.get("pluralSightKeyText"))));
        String key = driver.findElement(By.xpath(configMap.get("pluralSightKeyText"))).getAttribute("value");
        try {
            FileWriter fw = new FileWriter(new File("output/usersdata.csv"), true);
            fw.write(myFormElement.toString() + "," + key+"\n");
            fw.flush();
            fw.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    public void logoutUser(){
        ((JavascriptExecutor) driver).executeScript(configMap.get("dreamSparkLogoutJS"));
        //check if the user really logged out by checking the signin button presence
        webDriverWait.until(ExpectedConditions.visibilityOfElementLocated(By.xpath(configMap.get("dreamSparkSigninXpath"))));
    }
}
